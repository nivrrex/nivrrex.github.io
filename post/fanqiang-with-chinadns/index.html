<!DOCTYPE html>
<html lang="zh-CN">
   <head>
   <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="XN4YmHgE76jTp2kNQ9qnsVSApl6yIQBzdyLe0BnbFks" />
  <meta name="Description" content="Nivrrex&#39;s blog | This is nivrrex&#39;s home">
  <title>
    
    
    fanqiang with chinadns - Nivrrex&#39;s blog
    
  </title>
  <link rel="shortcut icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="all">
  <link rel="stylesheet" href="/css/bootstrap-theme.min.css">

<script src="/js/jquery.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/highlight/styles/.css">  
  <script src="/highlight/highlight.pack.js" type='text/javascript'></script>
  <script src="/js/bootstrap.min.js"></script>
 <script src="/js/holder.min.js" type='text/javascript'></script>
<script src="https://unpkg.com/ionicons@4.2.2/dist/ionicons.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
	hljs.initHighlightingOnLoad();
    $('div.src').each(function(i, block) {
	hljs.highlightBlock(block);
    });
});
  </script>


  <link rel="canonical" href="http://nivrrex.github.io/post/fanqiang-with-chinadns/">
  <link href="" rel="alternate" type="application/rss+xml" title="fanqiang with chinadns" />
   </head>
   <body data-spy="scroll" data-target="#toc">
     <header class="navbar navbar-default navbar-fixed-top" id="top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://nivrrex.github.io/">Nivrrex&#39;s blog</a>
    </div>

    
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
	
	
	<li  ><a href="/">Home</a></li>
	
	
	
	<li > <a href="http://nivrrex.github.io/post/ubnt-erx-use-openwrt/" >ubnt er-x use openwrt</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/use-cmder/" >use cmder</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/change-hexo-to-hugo/" >change hexo to hugo</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/start-to-use-python/" >start to use python</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/change-editer-with-sublime-text/" >change editer with sublime text</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/update-debian-linux-image-with-backports/" >update debian linux image with backports</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/fanqiang-with-dnsmasq/" >fanqiang with dnsmasq</a></li>
	

	
	
	<li  class="active"  > <a href="http://nivrrex.github.io/post/fanqiang-with-chinadns/" >fanqiang with chinadns</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/fanqiang-with-shadowsocks/" >fanqiang with shadowsocks</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/build-openwrt-with-image-builder/" >build openwrt with image builder</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/fanqiang-with-openwrt&#43;vps/" >fanqiang with openwrt&#43;vps</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/fanqiang-with-vpn&#43;chnroutes/" >fanqiang with vpn&#43;chnroutes</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/fanqiang-with-goagent/" >fanqiang with goagent</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/some-problems-for-golang-excel-update/" >some problems for golang excel update</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/commonly-used-software/" >commonly used software</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/hello-github/" >Hello GitHub</a></li>
	

	
	
	<li > <a href="http://nivrrex.github.io/post/about-me/" >About this blog</a></li>
	


	
	<li > <a href="/tags/" >Tags</a></li>
      </ul>
    </nav>
</header>

     <div class="jumbotron masthead" role="main">
       <div class="container">
	 <div class="row">

 	   <div class="col-md-8 col-md-offset-2 ">
	   
<div class="panel panel-default">
  <div class="panel-body">
      <article id='post' >
	<div class='title'> fanqiang with chinadns </div>
	  
	  <span class="text-muted"><ion-icon name="ios-calendar"></ion-icon>Posted by:&nbsp; <time tile="创建于" itemprop="dateCreated datePublished" datetime="Sun Jul 26, 2015">Sun Jul 26, 2015</time> | 
	  <ion-icon name="ios-podium"></ion-icon>Word Count: 1197&nbsp;&nbsp; | 
	  <ion-icon name="ios-time"></ion-icon> Reading Time: 6 Minute&nbsp;&nbsp;</span>

	  

<h4 id="来由">来由</h4>

<p>用Opera等浏览器时，由于DNS被GFW污染了，所以fanqiang的有些不爽快，像Twitter.com和Facebook.com无法上，虽然IE等借助Shadowsocks可以直接上？所以想在OpenWRT上，把DNS污染问题彻底解决了。</p>

<!-- more -->

<hr />

<h4 id="old解决方案-freerouterv2">Old解决方案 - FreeRouterV2</h4>

<p>以前的解决方案是借用<a href="https://github.com/lifetyper/FreeRouter_V2">FreeRouterV2</a>的部分iptables策略，针对被GFW污染的数据包进行丢弃，然后获得正常的数据包，具体原理作者详细的写了PDF文件进行说明，<a href="https://github.com/lifetyper/FreeRouter_V2/blob/master/FreeRouterV2_HandBook.pdf">如下</a></p>

<h6 id="安装">安装</h6>

<p>首先需要在OpenWRT上安装如下包：</p>

<pre><code class="language-bash">opkg update
opkg install iptables-mod-filter iptables-mod-u32 kmod-ipt-filter kmod-ipt-u32
</code></pre>

<h6 id="配置">配置</h6>

<p>然后配置iptables的防火墙策略</p>

<pre><code class="language-bash">vi /etc/firewall.user
</code></pre>

<p>添加如下命令</p>

<pre><code class="language-bash">iptables -t mangle -I PREROUTING -p udp --sport 53 -m u32 --u32 &quot;0&amp;0x0F000000=0x05000000 &amp;&amp; 0&gt;&gt;22&amp;0x3C@8&amp;0x810F=0x8000 &amp;&amp; 0&gt;&gt;22&amp;0x3C@12&amp;0xFFFF=0x0000&quot; -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|042442B2|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|0807C62D|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|1759053C|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|253D369E|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|2E52AE44|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|31027B38|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|364C8701|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|3B1803AD|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|402158A1|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4021632F|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4042A3FB|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4168CAFC|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|41A0DB71|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|422DFCED|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|480ECD63|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|480ECD68|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4A7D2766|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4A7D2771|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4A7D7F66|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4A7D9B66|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4D04075C|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|4E10310F|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|5D2E0859|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|76053106|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|80797E8B|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|9F6A794B|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|A9840D67|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|BC050460|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|BDA31105|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|C043C606|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|C504040C|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|CA6A0102|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|CAB50755|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|CB620741|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|CBA1E6AB|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|CF0C5862|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D0381F2B|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D1244921|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D155E58A|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D1913632|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D1DC1EAE|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D35E4293|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D5A9FB23|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D8DDBCB6|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|D8EAB30D|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|F3B9BB27|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|F9812E30|&quot; --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string &quot;|FD9D0EA5|&quot; --from 60 --to 180  -j DROP
</code></pre>

<p>重启防火墙即可</p>

<pre><code class="language-bash">/etc/init.d/firewall restart
</code></pre>

<h4 id="chinadns解决方案">ChinaDNS解决方案</h4>

<p>以上的方案挺好，但是GFW的污染IP似乎有增多现象，所以想省心一点，正好shadowsocks作者<a href="https://github.com/clowwindy">clowwindy</a>有一个针对DNS污染的作品<a href="https://github.com/clowwindy/ChinaDNS">ChinaDNS</a>，就直接拿过来用了。
针对OpenWRT/Gargoyle，作者有直接编译完毕的ipk包，下载后安装到OpenWRT即可，地址<a href="https://github.com/clowwindy/ChinaDNS/releases">如下</a></p>

<h6 id="安装-1">安装</h6>

<pre><code class="language-bash">opkg install ChinaDNS_1.x.x_ar71xx.ipk
/etc/init.d/chinadns start
/etc/init.d/chinadns enable
</code></pre>

<h6 id="配置-1">配置</h6>

<pre><code class="language-bash">vi /etc/dnsmasq.conf
</code></pre>

<p>添加如下内容并保存退出</p>

<pre><code class="language-bash">no-resolv
server=127.0.0.1#5353
</code></pre>

<p>重新启动</p>

<pre><code class="language-bash">/etc/init.d/chinadns restart
/etc/init.d/dnsmasq restart
</code></pre>

<p>此时直接使用路由器IP做DNS服务器即可，也可以对chinadns做更进一步的配置</p>

<pre><code class="language-bash">vi /etc/init.d/chinadns
</code></pre>

<p>具体参数如下</p>

<pre><code class="language-bash">usage: chinadns [-h] [-l IPLIST_FILE] [-b BIND_ADDR] [-p BIND_PORT]
       [-c CHNROUTE_FILE] [-s DNS] [-v]
Forward DNS requests.

-h, --help            show this help message and exit
-l IPLIST_FILE        path to ip blacklist file
-c CHNROUTE_FILE      path to china route file
                      if not specified, CHNRoute will be turned off
-d                    enable bi-directional CHNRoute filter
-y                    delay time for suspects, default: 0.3
-b BIND_ADDR          address that listens, default: 127.0.0.1
-p BIND_PORT          port that listens, default: 53
-s DNS                DNS servers to use, default:
                      114.114.114.114,208.67.222.222:443,8.8.8.8
-m                    Using DNS compression pointer mutation
                      (backlist and delaying would be disabled)
-v                    verbose logging
</code></pre>

<h4 id="sftp登录">SFTP登录</h4>

<p>在将ipx文件上传到OpenWRT路由器上时，刚开始没有使用WinSCP，而且OpenWRT上也没有SFTP服务，所以是用Everything的HTTP服务器功能，然后在OpenWRT上用wget下载的。后来知道可以直接通过SFTP上传、下载文件后，就开始在OpenWRT上折腾了。</p>

<h6 id="openwrt安装sftp">OpenWRT安装SFTP</h6>

<p>安装及配置命令如下：</p>

<pre><code class="language-bash">opkg update
opkg install vsftpd openssh-sftp-server
/etc/init.d/vsftpd enable
/etc/init.d/vsftpd start
</code></pre>

<h6 id="md5sum-mismatch-错误">md5sum mismatch 错误</h6>

<p>其中opkg在线安装openssh-sftp-server时出现了md5sum mismatch，无法安装，网上Google了一下，表示可能是linux内核不匹配导致的，解决方法是下载到本地，直接安装即可
好吧，打开Everything的HTTP服务器，先下载到OpenWRT路由器上，然后手动安装成功。</p>

<hr />

<h4 id="结">结</h4>

<p>没有了DNS污染，所有被屏蔽的网站也可以通过Shadowsocks+GFWList PAC绕过去科学上网了，自由遨游Internet的感觉真好啊~ \^O^/</p>


	  
	  	  <div class="tags">	

	      
	    
<p><ion-icon name="pricetag"></ion-icon>  <a itemprop="keywords"  class="label label-danger" href="/tags/chinadns">chinadns</a> <a itemprop="keywords"  class="label label-danger" href="/tags/fanqiang">fanqiang</a> <a itemprop="keywords"  class="label label-danger" href="/tags/internet">internet</a> <a itemprop="keywords"  class="label label-danger" href="/tags/openwrt">openwrt</a></p>



	    	  </div>
	    
<nav aria-label="...">
  <ul class="pager">
    
    <li class="previous">
      <a href="http://nivrrex.github.io/post/fanqiang-with-shadowsocks/"><span aria-hidden="true">&larr;</span>fanqiang with shadowsocks</a>
      
    </li>
    	
     
    
    <li class="next"><a href="http://nivrrex.github.io/post/fanqiang-with-dnsmasq/">fanqiang with dnsmasq<span aria-hidden="true">&rarr;</span></a></li>
    
  </ul>
</nav>



     </div>
      </div></article>


	 </div>

	 </div>
       </div>
     </div>

 <div class="container footer">
  <div class="row">
    <div class="col-md-10">
      <small class="text-muted">Copyright right infomation. Theme:<a href="https://hii8.com/">LeonHe</a></small>
    </div>
    <div class="col-md-2">
      <small class="text-muted">Your tips content</small>
      </div>
   </div>
 </div>

   </body>
     </html>
